#!/bin/bash
# Pre-push hook: rejects binary executables, WIP commits, and lints on main pushes.

remote="$1"
zero=$(git hash-object --stdin </dev/null | tr '0-9a-f' '0')

# Check all commits being pushed for binary executables.
while read -r local_ref local_oid _remote_ref remote_oid; do
	if [ "$local_oid" = "$zero" ]; then
		continue
	fi
	if [ "$remote_oid" = "$zero" ]; then
		range="$local_oid"
	else
		range="$remote_oid..$local_oid"
	fi
	# Reject binary executables in any commit being pushed.
	binaries=$(git diff-tree -r --name-only --diff-filter=ACM "$range" | while read -r f; do
		git cat-file -e "$local_oid:$f" 2>/dev/null && git show "$local_oid:$f" | file --mime-type - 2>/dev/null | grep -qE 'application/(x-executable|x-mach-binary|x-dosexec|x-pie-executable|x-sharedlib)' && echo "$f"
	done || true)
	if [ -n "$binaries" ]; then
		echo >&2 "âœ— Binary executables cannot be pushed:"
		echo >&2 "$binaries"
		exit 1
	fi
	commit=$(git rev-list -n 1 --grep '^WIP' "$range")
	if [ -n "$commit" ]; then
		echo >&2 "Found WIP commit in $local_ref, not pushing"
		exit 1
	fi
	if [ "$remote" = "origin" ] && [ "$local_ref" = "main" ]; then
		make lint
	fi
done
