# Android Guidelines

Kotlin/Compose Android app for caic. Voice-first companion for managing coding agents.

## Linting

**Always** run `make lint-android` after any Android/Kotlin file change. Do not skip this step.

## Current State

SDK module (generated API client + types), Compose UI, Hilt DI, and voice mode
(Phase 1) are implemented. The app has a task list screen, settings screen, and
a voice overlay with Gemini Live WebSocket integration. Phase 2 (full screen mode
with TaskDetail, message grouping, etc.) is not yet started.

## Architecture

See `docs/` for full design specs:
- `docs/sdk-design.md` — Kotlin SDK: generated API client + types
- `docs/app-design.md` — App: screens, voice mode, state management

### Layer Summary

```
UI (Compose screens) → ViewModels (StateFlow) → Repositories → SDK (ApiClient)
                                                             → Gemini Live (voice)
                                                             → DataStore (settings)
```

No business logic in Compose. No Android dependencies in the SDK module.

## Conventions

- **Package**: `com.fghbuild.caic` (app), `com.caic.sdk` (SDK module)
- **DI**: Hilt
- **Serialization**: `kotlinx.serialization` (not Gson/Moshi)
- **Networking**: OkHttp (HTTP + SSE + WebSocket)
- **Async**: Coroutines + `StateFlow` (not LiveData, not RxJava)
- **Navigation**: Compose Navigation with type-safe routes
- **Compose naming**: `PascalCase` for composables (detekt `functionPattern` allows this)
- **Line length**: 120 chars (detekt config)
- **No wildcard imports** (detekt enforced)

## Build & Lint

```bash
make lint-android   # detekt + Android lint
make android-build  # assembleDebug
make android-test   # JVM unit tests
```

Lint is strict: `warningsAsErrors = true`, `maxIssues: 0`.

## Gemini Live API

Official docs:
- https://ai.google.dev/api/live — WebSocket reference
- https://ai.google.dev/gemini-api/docs/ephemeral-tokens — token provisioning

### Voice token flow

1. Android calls `GET /api/v1/voice/token` on the caic backend.
2. Backend returns a token and an `ephemeral` boolean.
3. Android picks the WebSocket URL and auth parameter based on `ephemeral`.

The response's `ephemeral` field controls which path the client uses:

| Mode | `ephemeral` | Token source | WebSocket endpoint | Auth param |
|------|-------------|--------------|-------------------|------------|
| Raw key (current) | `false` | `GEMINI_API_KEY` directly | `v1beta.GenerativeService.BidiGenerateContent` | `?key=` |
| Ephemeral (disabled) | `true` | `POST /v1alpha/auth_tokens` | `v1alpha.GenerativeService.BidiGenerateContentConstrained` | `?access_token=` |

### API versioning

The raw key path uses **v1beta** + `BidiGenerateContent` and produces
higher-quality voice responses.

Ephemeral tokens are **v1alpha only** — both token creation and the
WebSocket endpoint must use `v1alpha`. Using `v1beta` for `auth_tokens`
returns 404. The v1alpha path works but produces lower-quality responses.
The ephemeral code is kept in the backend (`getVoiceTokenEphemeral`) for
future use once Google stabilises v1beta ephemeral tokens.

See https://ai.google.dev/gemini-api/docs/ephemeral-tokens.

### Audio configuration

See `docs/app-design.md` § "Audio gotchas" and the
[Firebase AI SDK AudioHelper.kt](https://github.com/firebase/firebase-android-sdk/blob/main/firebase-ai/src/main/kotlin/com/google/firebase/ai/type/AudioHelper.kt).

- **AudioTrack must use `USAGE_MEDIA`** — `VOICE_COMMUNICATION` clips first 1–2s.
- **BT disconnect**: car HFP hang-up doesn't remove the device — listen for `ACTION_SCO_AUDIO_STATE_UPDATED`.

### Protocol notes

- Client must wait for `BidiGenerateContentSetupComplete` before sending other messages.
- `mediaChunks` in `realtimeInput` is **deprecated** — use `audio`, `video`, or `text` fields instead.

## Development Notes

- `minSdk = 34`, `targetSdk = 36`, `compileSdk = 36`
- Version catalog at `gradle/libs.versions.toml`
- detekt config at `detekt.yml`
- The web frontend (SolidJS) in `../frontend/` is the reference implementation for
  screen behavior, event grouping, and formatting. Match it.

## Implementation Order

The app's unique value is voice control. Screen mode is secondary (the web
frontend already exists). Follow the design docs in this order:

1. ~~**SDK module** (`docs/sdk-design.md`)~~ — Done.
2. ~~**Voice mode** (`docs/app-design.md` Phase 1)~~ — Done.
3. **Screen mode** (`docs/app-design.md` Phase 2): full Compose UI with feature
   parity to the web frontend — TaskDetail, message grouping, tool call display,
   turn elision, background service, notifications.

Each step should build, lint, and test clean before proceeding.

<!-- BEGIN FILE INDEX -->
## File Index

Autogenerated file index based on first-line comments.

- `app/src/main/java/com/fghbuild/caic/CaicApp.kt`: Hilt application entry point.
- `app/src/main/java/com/fghbuild/caic/CaicNavGraph.kt`: Top-level composable hosting the navigation graph with voice panel.
- `app/src/main/java/com/fghbuild/caic/MainActivity.kt`: Single activity host for Jetpack Compose UI.
- `app/src/main/java/com/fghbuild/caic/data/SettingsRepository.kt`: Persisted user settings backed by DataStore preferences.
- `app/src/main/java/com/fghbuild/caic/data/TaskRepository.kt`: Singleton repository managing the global SSE connection, task list, and per-task event streams.
- `app/src/main/java/com/fghbuild/caic/di/DataModule.kt`: Hilt module providing DataStore and ApiClient singletons.
- `app/src/main/java/com/fghbuild/caic/navigation/Screen.kt`: Navigation routes for the app.
- `app/src/main/java/com/fghbuild/caic/ui/settings/SettingsScreen.kt`: Compose Settings screen for configuring server URL and voice.
- `app/src/main/java/com/fghbuild/caic/ui/settings/SettingsViewModel.kt`: ViewModel for the Settings screen, managing connection testing and preference updates.
- `app/src/main/java/com/fghbuild/caic/ui/taskdetail/AskQuestionCard.kt`: Card for an ask question with options and answer display.
- `app/src/main/java/com/fghbuild/caic/ui/taskdetail/ElidedTurn.kt`: Collapsed past turn: shows summary, expands to full content on click.
- `app/src/main/java/com/fghbuild/caic/ui/taskdetail/InputBar.kt`: Bottom input bar with send, sync, and terminate actions.
- `app/src/main/java/com/fghbuild/caic/ui/taskdetail/ResultCard.kt`: Card for a result event: success/error with metadata.
- `app/src/main/java/com/fghbuild/caic/ui/taskdetail/SafetyDialog.kt`: Alert dialog listing safety issues from a sync attempt.
- `app/src/main/java/com/fghbuild/caic/ui/taskdetail/TaskDetailScreen.kt`: Full-screen task detail view with live SSE message stream, grouping, and actions.
- `app/src/main/java/com/fghbuild/caic/ui/taskdetail/TaskDetailViewModel.kt`: ViewModel for the task detail screen: SSE message stream, grouping, and actions.
- `app/src/main/java/com/fghbuild/caic/ui/taskdetail/TextMessageGroup.kt`: Renders a text group: combines textDelta fragments, renders markdown.
- `app/src/main/java/com/fghbuild/caic/ui/taskdetail/TodoPanel.kt`: Collapsible TODO list panel showing task progress.
- `app/src/main/java/com/fghbuild/caic/ui/taskdetail/ToolCallCard.kt`: Expandable card for a single tool call: name, detail, duration, error.
- `app/src/main/java/com/fghbuild/caic/ui/taskdetail/ToolMessageGroup.kt`: Renders a tool group: single card or collapsible group with summary.
- `app/src/main/java/com/fghbuild/caic/ui/taskdetail/TurnContent.kt`: Renders all message groups within a single turn.
- `app/src/main/java/com/fghbuild/caic/ui/tasklist/TaskCard.kt`: Rich task card matching TaskItemSummary.tsx: state badge, plan mode, error, branch, tokens.
- `app/src/main/java/com/fghbuild/caic/ui/tasklist/TaskListScreen.kt`: Task list screen with creation form, usage badges, and task navigation.
- `app/src/main/java/com/fghbuild/caic/ui/tasklist/TaskListViewModel.kt`: ViewModel for the task list screen: SSE tasks, usage, creation form, and config.
- `app/src/main/java/com/fghbuild/caic/ui/tasklist/UsageBadges.kt`: Usage badges showing API utilization with color-coded thresholds.
- `app/src/main/java/com/fghbuild/caic/ui/theme/Theme.kt`: Material 3 theme with state-based task colors.
- `app/src/main/java/com/fghbuild/caic/util/Formatting.kt`: Display formatting utilities for tasks: tokens, cost, elapsed time, and tool detail.
- `app/src/main/java/com/fghbuild/caic/util/Grouping.kt`: Message grouping and turn splitting, ported from frontend/src/TaskView.tsx.
- `app/src/main/java/com/fghbuild/caic/voice/FunctionDeclarations.kt`: Gemini Live function declaration structures for voice mode tool calling.
- `app/src/main/java/com/fghbuild/caic/voice/FunctionHandlers.kt`: Dispatches Gemini function calls to the caic API.
- `app/src/main/java/com/fghbuild/caic/voice/LiveApiProto.kt`: Kotlin data classes for the Gemini Live API WebSocket protocol.
- `app/src/main/java/com/fghbuild/caic/voice/TaskNumberMap.kt`: Bidirectional map between task IDs and stable 1-based human-friendly numbers.
- `app/src/main/java/com/fghbuild/caic/voice/VoiceOverlay.kt`: Bottom voice panel composable: mic button, status, and transcription display.
- `app/src/main/java/com/fghbuild/caic/voice/VoiceService.kt`: Foreground service that keeps the app alive during a voice session.
- `app/src/main/java/com/fghbuild/caic/voice/VoiceSessionManager.kt`: Manages Gemini Live WebSocket session, audio I/O, and function call dispatch.
- `app/src/main/java/com/fghbuild/caic/voice/VoiceViewModel.kt`: Activity-scoped ViewModel bridging VoiceSessionManager to the voice overlay UI.
- `app/src/test/java/com/fghbuild/caic/util/FormattingTest.kt`: Unit tests for formatting utilities.
- `app/src/test/java/com/fghbuild/caic/util/GroupingTest.kt`: Unit tests for message grouping and turn splitting logic.
- `detekt.yml`: Detekt configuration for caic Android project.
- `docs/DEBUGGING_EMULATOR.md`: Debugging with the Android Emulator
- `docs/app-design.md`: Android App Design
- `docs/sdk-design.md`: Kotlin SDK Design
- `sdk/src/main/kotlin/com/caic/sdk/ApiClient.kt`: Code generated by gen-api-client. DO NOT EDIT.
- `sdk/src/main/kotlin/com/caic/sdk/Types.kt`: Code generated by gen-api-client. DO NOT EDIT.
<!-- END FILE INDEX -->
