# Backend Guidelines

Go backend for caic. Packages under `internal/` are private.

## Conventions

- Pass `context.Context` through all call chains.
- Serialize git operations that touch the working directory (branch checkout, push).

## References

Claude Code headless:
- https://platform.claude.com/docs/en/agent-sdk/streaming-output: explains the streaming protocol
- git clone https://github.com/anthropics/claude-agent-sdk-python to get the SDK and understand types, in particular `src/claude_agent_sdk/types.py`


<!-- BEGIN FILE INDEX -->
## File Index

Autogenerated file index based on first-line comments.

- `frontend/frontend.go`: Package frontend embeds the built frontend assets.
- `internal/agent/agent.go`: Package agent defines shared types and infrastructure for coding agent
- `internal/agent/claude/claude.go`: Package claude implements agent.Backend for Claude Code.
- `internal/agent/claude/unknown.go`: Package claudecode provides Go types for Claude Code JSONL session logs.
- `internal/agent/gemini/gemini.go`: Package gemini implements agent.Backend for Gemini CLI.
- `internal/agent/gemini/unknown.go`: Package gemini provides Go types for Gemini CLI stream-json session logs.
- `internal/agent/relay/embed.go`: Package relay embeds the Python relay script used inside containers.
- `internal/agent/relay/relay.py`: Persistent relay for claude processes inside caic containers.
- `internal/cmd/gen-api-client/main.go`: Generates a typed TypeScript API client from the Go route declarations.
- `internal/container/container.go`: Package container wraps md container lifecycle operations.
- `internal/gitutil/git.go`: Package gitutil provides git operations for branch management and pushing.
- `internal/server/compress.go`: Response compression middleware for API endpoints.
- `internal/server/decompress.go`: Request body decompression based on Content-Encoding.
- `internal/server/dto/errors.go`: Structured API error types and constructors.
- `internal/server/dto/events.go`: SSE event types sent to the frontend for task event streams.
- `internal/server/dto/routes.go`: API route declarations used by the code generator to produce a typed TS client.
- `internal/server/dto/types.go`: Exported request and response types for the caic API.
- `internal/server/dto/validate.go`: Request validation methods (excluded from tygo generation).
- `internal/server/eventconv.go`: Conversion from internal agent.Message types to dto.EventMessage for SSE.
- `internal/server/handler.go`: Generic HTTP handler wrappers that decode requests, validate, call a typed
- `internal/server/response.go`: JSON response writers for success and structured error responses.
- `internal/server/server.go`: Package server provides the HTTP server serving the API and embedded
- `internal/server/static.go`: Precompressed static file handler for embedded frontend assets.
- `internal/server/usage.go`: Claude Code OAuth usage quota fetcher with caching, credential file
- `internal/task/task.go`: Package task orchestrates a single coding agent task: branch creation,
<!-- END FILE INDEX -->
