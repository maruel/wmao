# Backend Guidelines

Go backend for caic. Packages under `internal/` are private.

## Linting

**Always** run `make lint-go` after any `.go` file change. Do not skip this step.

## Conventions

- Pass `context.Context` through all call chains.
- Serialize git operations that touch the working directory (branch checkout, push).
- Use subtests (`t.Run`) to group related test cases under a single `Test*` function.

## Container Adoption

Adopted containers (preexisting containers found on server restart) have the relay running inside them. This
permits the user to restart the server, e.g. for a software update, without losing their coding sessions.

## References

Claude Code headless:
- https://platform.claude.com/docs/en/agent-sdk/streaming-output: explains the streaming protocol
- git clone https://github.com/anthropics/claude-agent-sdk-python to get the SDK and understand types, in particular `src/claude_agent_sdk/types.py`


<!-- BEGIN FILE INDEX -->
## File Index

Autogenerated file index based on first-line comments.

- `frontend/frontend.go`: Package frontend embeds the built frontend assets.
- `internal/agent/agent.go`: Package agent defines shared types and infrastructure for coding agent
- `internal/agent/claude/claude.go`: Package claude implements agent.Backend for Claude Code.
- `internal/agent/claude/unknown.go`: Package claudecode provides Go types for Claude Code JSONL session logs.
- `internal/agent/codex/codex.go`: Package codex implements agent.Backend for Codex CLI.
- `internal/agent/codex/unknown.go`: Package codex provides Go types for Codex CLI app-server JSON-RPC session logs.
- `internal/agent/fake/embed.go`: Package fake embeds the fake agent Python script for e2e testing.
- `internal/agent/fake/fake_agent.py`: Fake agent that cycles through jokes, emitting Claude Code streaming JSON.
- `internal/agent/gemini/gemini.go`: Package gemini implements agent.Backend for Gemini CLI.
- `internal/agent/gemini/unknown.go`: Package gemini provides Go types for Gemini CLI stream-json session logs.
- `internal/agent/relay/embed.go`: Package relay embeds the Python relay script used inside containers.
- `internal/agent/relay/relay.py`: Persistent relay for coding agent processes inside caic containers.
- `internal/cmd/gen-api-sdk/main.go`: Generates typed TypeScript and Kotlin API clients plus API.md from the Go route declarations.
- `internal/container/container.go`: Package container wraps md container lifecycle operations.
- `internal/gitutil/git.go`: Package gitutil provides git operations for branch management and pushing.
- `internal/server/compress.go`: Response compression middleware for API endpoints.
- `internal/server/decompress.go`: Request body decompression based on Content-Encoding.
- `internal/server/dto/dto.go`: Package dto provides shared API infrastructure (errors, validation interface)
- `internal/server/dto/errors.go`: Structured API error types and constructors shared across all API versions.
- `internal/server/dto/v1/events.go`: SSE event types sent to the frontend for task event streams.
- `internal/server/dto/v1/routes.go`: API route declarations used by the code generator to produce typed TS and Kotlin clients.
- `internal/server/dto/v1/types.go`: Exported request and response types for the caic API.
- `internal/server/dto/v1/validate.go`: Request validation methods (excluded from tygo generation).
- `internal/server/eventconv.go`: Conversion from internal agent.Message types to v1.ClaudeEventMessage for
- `internal/server/genericconv.go`: Backend-neutral conversion from agent.Message to v1.EventMessage for SSE.
- `internal/server/handler.go`: Generic HTTP handler wrappers that decode requests, validate, call a typed
- `internal/server/response.go`: JSON response writers for success and structured error responses.
- `internal/server/server.go`: Package server provides the HTTP server serving the API and embedded
- `internal/server/static.go`: Precompressed static file handler for embedded frontend assets.
- `internal/server/usage.go`: Claude Code OAuth usage quota fetcher with caching, credential file
- `internal/task/task.go`: Package task orchestrates a single coding agent task: branch creation,
<!-- END FILE INDEX -->
